<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Coccinelle - Nihaal</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Abdun Nihaal" /><meta name="description" content="Coccinelle is static analysis tool used for semantic pattern matching and automated transformation of C programs. It is written in OCaml. Unlike other pattern matching tools like grep which use regular expressions, Coccinelle understands C syntax and can find semantic code pattern in the source code and automatically transform them, irrespective of the name of identifiers, comments or formatting.
Coccinelle is intraprocedural, i.e. all its matching and transformation happens within functions." />






<meta name="generator" content="Hugo 0.105.0 with theme even" />


<link rel="canonical" href="https://nihaal.me/post/coccinelle/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Coccinelle" />
<meta property="og:description" content="Coccinelle is static analysis tool used for semantic pattern matching and automated transformation of C programs. It is written in OCaml. Unlike other pattern matching tools like grep which use regular expressions, Coccinelle understands C syntax and can find semantic code pattern in the source code and automatically transform them, irrespective of the name of identifiers, comments or formatting.
Coccinelle is intraprocedural, i.e. all its matching and transformation happens within functions." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://nihaal.me/post/coccinelle/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-12-14T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-12-14T00:00:00+00:00" /><meta property="og:site_name" content="Nihaal" />

<meta itemprop="name" content="Coccinelle">
<meta itemprop="description" content="Coccinelle is static analysis tool used for semantic pattern matching and automated transformation of C programs. It is written in OCaml. Unlike other pattern matching tools like grep which use regular expressions, Coccinelle understands C syntax and can find semantic code pattern in the source code and automatically transform them, irrespective of the name of identifiers, comments or formatting.
Coccinelle is intraprocedural, i.e. all its matching and transformation happens within functions."><meta itemprop="datePublished" content="2022-12-14T00:00:00+00:00" />
<meta itemprop="dateModified" content="2022-12-14T00:00:00+00:00" />
<meta itemprop="wordCount" content="896">
<meta itemprop="keywords" content="linux,kernel," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Coccinelle"/>
<meta name="twitter:description" content="Coccinelle is static analysis tool used for semantic pattern matching and automated transformation of C programs. It is written in OCaml. Unlike other pattern matching tools like grep which use regular expressions, Coccinelle understands C syntax and can find semantic code pattern in the source code and automatically transform them, irrespective of the name of identifiers, comments or formatting.
Coccinelle is intraprocedural, i.e. all its matching and transformation happens within functions."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Nihaal</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Nihaal</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Coccinelle</h1>

      <div class="post-meta">
        <span class="post-time"> 14-12-2022 </span>
        
          <span class="more-meta"> 896 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#installing-and-using-coccinelle">Installing and using Coccinelle</a></li>
        <li><a href="#writing-semantic-patches">Writing Semantic patches</a>
          <ul>
            <li><a href="#metavariable-declaration">Metavariable declaration</a></li>
            <li><a href="#transformation-specification">Transformation specification</a></li>
            <li><a href="#rule-dependencies">Rule dependencies</a></li>
            <li><a href="#advanced-features">Advanced features</a></li>
          </ul>
        </li>
        <li><a href="#examples">Examples</a></li>
        <li><a href="#references">References</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Coccinelle is static analysis tool used for semantic pattern matching and automated transformation of C programs.
It is written in OCaml.
Unlike other pattern matching tools like grep which use regular expressions, Coccinelle understands C syntax and
can find semantic code pattern in the source code and automatically transform them, irrespective of the name of identifiers, comments or formatting.</p>
<p>Coccinelle is <em>intraprocedural</em>, i.e. all its matching and transformation happens within functions.</p>
<p>It can be used for</p>
<ol>
<li>
<p>Fixing bugs based on the bug pattern. For example, whenever we allocate memory using kmalloc, we have to check if the return value is NULL.
Using coccinelle, we can find places in the code where the check is not performed.
This allows us to &ldquo;Find (a bug) once, Fix everywhere&rdquo;.</p>
</li>
<li>
<p>Performing <em>collateral evolutions</em>, i.e. making a change that needs to be propagated throughout the codebase.
For example, a change in the arguments used for a function needs updating all the points in the code where that function is called.
Similarly, there could be old deprecated functions that need to be replaced by new alternatives.</p>
</li>
</ol>
<p>Coccinelle takes as input the C program files that need to be matched and transformed, and a <em>semantic patch</em>.
Semantic patches are coccinelle scripts written in Semantic Patch Language (SmPL), that specifies the code pattern that needs to be matched
and the code transformation that needs to be performed.
The syntax of semantic patches is similar to C and the notations used in patches (eg: <em>+</em> to denote added lines and <em>-</em> to denote deleted lines).</p>
<h2 id="installing-and-using-coccinelle">Installing and using Coccinelle</h2>
<ul>
<li>
<p>To install coccinelle from source</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  git clone https://github.com/coccinelle/coccinelle
</span></span><span class="line"><span class="cl">  <span class="nb">cd</span> coccinelle
</span></span><span class="line"><span class="cl">  ./autogen
</span></span><span class="line"><span class="cl">  ./configure
</span></span><span class="line"><span class="cl">  make
</span></span><span class="line"><span class="cl">  sudo make install
</span></span></code></pre></td></tr></table>
</div>
</div><p>This will install a tool called <strong>spatch</strong>, which is like the <em>patch</em> tool but for semantic patches.
We use spatch for applying semantic patches.</p>
</li>
<li>
<p>To check if your semantic patch is valid:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  spatch --parse-cocci your_patch.cocci
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>To apply or run your patch on a file or directory:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  spatch --sp-file your_patch.cocci file.c
</span></span><span class="line"><span class="cl">  spatch --sp-file your_patch.cocci --dir directory
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>To set a virtual dependency (like report,patch,org) use -D flag:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  spatch -D report --sp-file your_patch.cocci file.c
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="writing-semantic-patches">Writing Semantic patches</h2>
<ul>
<li>Writing semantic patches
<ul>
<li>Write a patch for the change</li>
<li>Abstract unneeded code with &hellip;</li>
<li>Abstract over identifiers, expressions and constants with metavariables</li>
<li>Check for matches and refine incrementally for special cases</li>
</ul>
</li>
</ul>
<p>A semantic patch consists of many <em>rules</em> and each rule consists of two parts:</p>
<ol>
<li>Metavariable declaration</li>
<li>Transformation specification</li>
</ol>
<p>The general structure of a rule is given below: (The rule name is optional.)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">@rule_name@
</span></span><span class="line"><span class="cl">// Metavariable declaration
</span></span><span class="line"><span class="cl">@@
</span></span><span class="line"><span class="cl">// Transformation specification
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="metavariable-declaration">Metavariable declaration</h3>
<p>Metavariables are used to abstract over identifiers, expressions, constants and types.
For example, if I use a metavariable of type <em>expression</em> , it can match over any C expression.
We can also use metavariables of a specific struct or type defined in the program.</p>
<h3 id="transformation-specification">Transformation specification</h3>
<ul>
<li>
<p>Matching code</p>
<p>We can use (three) dot symbols: <strong>&hellip;</strong> to match any code. This allows us to match lines irrespective of
the code present between the lines.
However, in some situations, we may want to restrict the code that we want to skip.
For this, we can use the <strong>when</strong> clause along with the dots.</p>
</li>
<li>
<p>Transforming code</p>
<p>The left most column specifies the transformation that needs to be performed.
The following symbols have special meaning when used as the first character in a line:</p>
<ul>
<li><strong>+</strong>  adds the line to the matched code</li>
<li><strong>-</strong>   removes the matched line</li>
<li><strong>*</strong>   highlights the matched line</li>
<li>Disjunction: We can also specify multiple possible match patterns using the symbols <strong>( | )</strong> in the first column</li>
</ul>
</li>
</ul>
<h3 id="rule-dependencies">Rule dependencies</h3>
<h3 id="advanced-features">Advanced features</h3>
<ul>
<li>Embedding Python/Ocaml scripts</li>
<li>Isomorphism</li>
<li>Position metavariables</li>
<li>Adding constraints using when</li>
<li>Iterations</li>
</ul>
<h2 id="examples">Examples</h2>
<ol>
<li>Hello World example</li>
</ol>
<p>The following script removes 1 &lt;&lt; c in lines and replaces with BIT(c) where c
can be any number</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">   @@
</span></span><span class="line"><span class="cl">   constant c;
</span></span><span class="line"><span class="cl">   @@
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   - 1 &lt;&lt; c
</span></span><span class="line"><span class="cl">   + BIT(c)
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>Use of disjunctions and expressions</li>
</ol>
<p>But c can be an expression like (3*somevar), in that case we use an expression
Here we also use a disjunction | operator</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">   @@
</span></span><span class="line"><span class="cl">   constant c;
</span></span><span class="line"><span class="cl">   expression E;
</span></span><span class="line"><span class="cl">   @@
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   {
</span></span><span class="line"><span class="cl">   - 1 &lt;&lt; c
</span></span><span class="line"><span class="cl">   + BIT(c)
</span></span><span class="line"><span class="cl">   |
</span></span><span class="line"><span class="cl">   - 1 &lt;&lt; E
</span></span><span class="line"><span class="cl">   + BIT(E)
</span></span><span class="line"><span class="cl">   }
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>Use of depends</li>
</ol>
<p>The following example checks if BITS is used in the file and only then replaces
otherwise it doesn&rsquo;t do anything
&hellip; can be use to match any code that we don&rsquo;t care about</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">   @usesbit@
</span></span><span class="line"><span class="cl">   @@
</span></span><span class="line"><span class="cl">   BIT(...)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   @depends on usesbit@
</span></span><span class="line"><span class="cl">   expression E;
</span></span><span class="line"><span class="cl">   @@
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   - 1 &lt;&lt; E
</span></span><span class="line"><span class="cl">   + BIT(E)
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>Use of identifiers</li>
</ol>
<p>The following example compresses return statement lines</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">   @@
</span></span><span class="line"><span class="cl">   identifier f;
</span></span><span class="line"><span class="cl">   expression r;
</span></span><span class="line"><span class="cl">   @@
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   - r = f(...);
</span></span><span class="line"><span class="cl">   + return f(...);
</span></span><span class="line"><span class="cl">   - return r;
</span></span></code></pre></td></tr></table>
</div>
</div><p>To match multiple instances use &lt;&hellip; &hellip;&gt;
The following code highlights every function call inside every function</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">   @@
</span></span><span class="line"><span class="cl">   identifier f;
</span></span><span class="line"><span class="cl">   @@
</span></span><span class="line"><span class="cl">   *f(...)
</span></span><span class="line"><span class="cl">   {
</span></span><span class="line"><span class="cl">   &lt;...
</span></span><span class="line"><span class="cl">   * g(...)
</span></span><span class="line"><span class="cl">   ...&gt;
</span></span><span class="line"><span class="cl">   }
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="references">References</h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=2sfJ9HNlU5w">Coccinelle: Finding bugs in the Linux Kernel - Vaishali Thakkar - FOSSASIA Summit 2017</a></li>
<li><a href="https://www.youtube.com/watch?v=xA5FBvuCvMs">Keynote: Inside the Mind of a Coccinelle Programmer by Julia Lawall, Developer of Coccinelle</a></li>
<li><a href="http://coccinellery.org">http://coccinellery.org</a></li>
<li><a href="https://www.youtube.com/watch?v=buZrNd6XkEw">Julia Lawall: An Introduction to Coccinelle Bug Finding and Code Evolution for the Linux Kernel</a></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Abdun Nihaal</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        14-12-2022
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/linux/">linux</a>
          <a href="/tags/kernel/">kernel</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/syzkaller/">
            <span class="next-text nav-default">Finding bugs with Syzkaller</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="https://www.twitter.com/nihaal_an" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://in.linkedin.com/in/abdun-nihaal-289272143" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="https://www.github.com/nifey" class="iconfont icon-github" title="github"></a>
      <a href="https://www.gitlab.com/nihaal" class="iconfont icon-gitlab" title="gitlab"></a>
  <a href="https://nihaal.me/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2016 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span>Abdun Nihaal</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
