<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Misc character devices - Nihaal</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Abdun Nihaal" /><meta name="description" content="Misc Char device Creating a character device involves choosing a major and minor number to use and registering the device with the kernel. For creating simple character device files which are not associated with any hardware or cannot be put in any other Major number categories, we can instead create a Miscellaneous character device.
Misc char devices makes device registration a bit easier. The functions for handling open and llseek syscalls on misc char devices are already defined." />






<meta name="generator" content="Hugo 0.88.1 with theme even" />


<link rel="canonical" href="https://nihaal.me/post/misc_char_devices/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Misc character devices" />
<meta property="og:description" content="Misc Char device Creating a character device involves choosing a major and minor number to use and registering the device with the kernel. For creating simple character device files which are not associated with any hardware or cannot be put in any other Major number categories, we can instead create a Miscellaneous character device.
Misc char devices makes device registration a bit easier. The functions for handling open and llseek syscalls on misc char devices are already defined." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://nihaal.me/post/misc_char_devices/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-11-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-11-03T00:00:00+00:00" /><meta property="og:site_name" content="Nihaal" />

<meta itemprop="name" content="Misc character devices">
<meta itemprop="description" content="Misc Char device Creating a character device involves choosing a major and minor number to use and registering the device with the kernel. For creating simple character device files which are not associated with any hardware or cannot be put in any other Major number categories, we can instead create a Miscellaneous character device.
Misc char devices makes device registration a bit easier. The functions for handling open and llseek syscalls on misc char devices are already defined."><meta itemprop="datePublished" content="2021-11-03T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-11-03T00:00:00+00:00" />
<meta itemprop="wordCount" content="1454">
<meta itemprop="keywords" content="linux,kernel," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Misc character devices"/>
<meta name="twitter:description" content="Misc Char device Creating a character device involves choosing a major and minor number to use and registering the device with the kernel. For creating simple character device files which are not associated with any hardware or cannot be put in any other Major number categories, we can instead create a Miscellaneous character device.
Misc char devices makes device registration a bit easier. The functions for handling open and llseek syscalls on misc char devices are already defined."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Nihaal</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Nihaal</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Misc character devices</h1>

      <div class="post-meta">
        <span class="post-time"> 03-11-2021 </span>
        
          <span class="more-meta"> 1454 words </span>
          <span class="more-meta"> 7 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#misc-char-device">Misc Char device</a></li>
        <li><a href="#creating-a-misc-char-device">Creating a Misc Char device</a></li>
        <li><a href="#an-example-echo-device">An example: Echo device</a>
          <ul>
            <li><a href="#echo-dot-c">echo.c</a></li>
            <li><a href="#makefile">Makefile</a></li>
            <li><a href="#testing-echo">Testing echo</a></li>
          </ul>
        </li>
        <li><a href="#references">References</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="misc-char-device">Misc Char device</h2>
<p>Creating a character device involves choosing a major and minor number to use and registering the device with the kernel.
For creating simple character device files which are not associated with any hardware or cannot be put in any other Major number categories, we can instead create a Miscellaneous character device.</p>
<p>Misc char devices makes device registration a bit easier.
The functions for handling open and llseek syscalls on misc char devices are already defined.
We only have to define functions for other syscalls that we want to support.
Also, All misc devices share the same major number: 10 (defined as MISC_MAJOR).</p>
<h2 id="creating-a-misc-char-device">Creating a Misc Char device</h2>
<p>The structure and functions needed to create misc char devices are given below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">miscdevice</span>  <span class="p">{</span>
	<span class="kt">int</span> <span class="n">minor</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="o">*</span><span class="n">fops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">this_device</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">**</span><span class="n">groups</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nodename</span><span class="p">;</span>
	<span class="n">umode_t</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="nf">misc_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">miscdevice</span> <span class="o">*</span><span class="n">misc</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">misc_deregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">miscdevice</span> <span class="o">*</span><span class="n">misc</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>To create a misc char device:</p>
<ol>
<li>Include <a href="https://elixir.bootlin.com/linux/latest/source/include/linux/miscdevice.h">include/linux/miscdevice.h</a> file as it contains the structure and functions used for creating a misc char device.</li>
<li>Initialize a miscdevice structure</li>
<li>Register the miscdevice using the <em>misc_register</em> function in the initialization function of the kernel module</li>
<li>Unregister the miscdevice using the <em>misc_unregister</em> funciton in the exit function</li>
</ol>
<h2 id="an-example-echo-device">An example: Echo device</h2>
<p>To better understand how to create a misc char device, we will look at a kernel module that implements an <strong>echo</strong> device.</p>
<ul>
<li>When we write to the echo device file, it will store upto a page of data</li>
<li>When we read from the echo device file, it will return the data that was last written</li>
</ul>
<p>I have given the source code of the module with explanations in between.</p>
<h3 id="echo-dot-c">echo.c</h3>
<h4 id="prelude">Prelude</h4>
<ul>
<li>Include header files. The first three headers are required by all kernel modules.</li>
<li>Use module macros to add license, author and description</li>
</ul>
<!--listend-->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span><span class="cpf">&lt;linux/init.h&gt;</span><span class="cp">
</span><span class="cp">#include</span><span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
</span><span class="cp">#include</span><span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
</span><span class="cp">#include</span><span class="cpf">&lt;linux/fs.h&gt;            // For struct file_operations</span><span class="cp">
</span><span class="cp">#include</span><span class="cpf">&lt;linux/miscdevice.h&gt;    // For struct misc device and register functions</span><span class="cp">
</span><span class="cp">#include</span><span class="cpf">&lt;linux/uaccess.h&gt;       // For permissions macros</span><span class="cp">
</span><span class="cp">#include</span><span class="cpf">&lt;linux/slab.h&gt;          // For kzalloc</span><span class="cp">
</span><span class="cp">#include</span><span class="cpf">&lt;linux/string.h&gt;        // For string helper functions</span><span class="cp">
</span><span class="cp">#include</span><span class="cpf">&lt;linux/rwsem.h&gt;         // For reader-writers lock</span><span class="cp">
</span><span class="cp"></span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&#34;GPL&#34;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&#34;Nihaal&#34;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&#34;Misc char driver&#34;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="buffer-allocation-and-locking">Buffer allocation and Locking</h4>
<p>We need to allocate some space to store the data that is written to the device file.
To do that, we first declare a static char pointer <em>kernel_buffer</em>.</p>
<p>Then in the initialization function of the module, we allocate memory using the <em>kzalloc</em> function.
<em>kzalloc</em> function takes as input, the size of memory to allocate (in bytes) and the type of memory to allocate.
It allocates the required memory and zero fills it.
We use <em>GFP_KERNEL</em> which is used for kernel internal allocations, as the type of memory.</p>
<p>Any memory allocated dynamically should be freed when the module exits.
So in the exit function, we use <em>kfree</em> to deallocate memory occupied by the buffer.</p>
<p>Multiple processes may try to read or write to the device file concurrently.
To avoid an inconsistent state, we use a reader-writer lock to protect the buffer.
The reader-writer lock allows multiple readers to read simultaneously, but when a process is writing
to the buffer, no other process can read or write to it at the same time.</p>
<p><em>DECLARE_RWSEM</em> macro declares a reader-writer&rsquo;s lock.
We can then use <em>down_read, down_write</em> functions to acquire the lock for reading or writing, and release it with
<em>up_read</em> or <em>up_write</em> depending on which down function we used.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">kernel_buffer</span><span class="p">;</span>
<span class="k">static</span> <span class="nf">DECLARE_RWSEM</span><span class="p">(</span><span class="n">echo_rwlock</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="read-function">Read function</h4>
<p>Here we define echo_read function which will be executed when a process reads from the device file.
The read function should</p>
<ul>
<li>Copy the requested amount (<em>size</em> bytes) of data into the user buffer (<em>user_buffer</em>),</li>
<li>Update the file offset (<em>file_pos</em>)</li>
<li>Return
<ul>
<li>the number of bytes copied to the user buffer, if the copy was successful</li>
<li>0, if the End of File is reached</li>
<li>negative value, if there is an error</li>
</ul>
</li>
</ul>
<p>We cannot copy data from the kernel buffer to user buffer directly as they are on different address spaces.
So we use <em>copy_to_user</em> function to copy data from the kernel address space to the user process address space.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">ssize_t</span> <span class="nf">echo_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">user_buffer</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">file_pos</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="c1">// Check if a page of data has been read already
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">file_pos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="c1">// Acquire read lock
</span><span class="c1"></span>	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">echo_rwlock</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span><span class="o">?</span> <span class="nl">PAGE_SIZE</span><span class="p">:</span> <span class="n">size</span><span class="p">;</span>
	<span class="c1">// Copy data to user buffer
</span><span class="c1"></span>	<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">user_buffer</span><span class="p">,</span> <span class="n">kernel_buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">ret</span><span class="p">;</span>
	<span class="o">*</span><span class="n">file_pos</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="c1">// Release read lock
</span><span class="c1"></span>	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">echo_rwlock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="write-function">Write function</h4>
<p>Here we define echo_write function which will be executed when a process writes to the device file.
The write function should</p>
<ul>
<li>Copy the requested amount (<em>size</em> bytes) of data from the user buffer (<em>user_buffer</em>),</li>
<li>Update the file offset (<em>file_pos</em>)</li>
<li>Return
<ul>
<li>the number of bytes left to be copied, if the copy was successful</li>
<li>negative value, if there is an error</li>
</ul>
</li>
</ul>
<p>Here again, since we cannot directly copy data between kernel and user address spaces, we use <em>copy_from_user</em> function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">ssize_t</span> <span class="nf">echo_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">user_buffer</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">file_pos</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="c1">// Check if a page of data has been written already
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">file_pos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="c1">// Acquire write lock
</span><span class="c1"></span>	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">echo_rwlock</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">kernel_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span><span class="o">?</span> <span class="nl">PAGE_SIZE</span><span class="p">:</span> <span class="n">size</span><span class="p">;</span>
	<span class="c1">// Copy data to kernel buffer
</span><span class="c1"></span>	<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">kernel_buffer</span><span class="p">,</span> <span class="n">user_buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">ret</span><span class="p">;</span>
	<span class="o">*</span><span class="n">file_pos</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="c1">// Release write lock
</span><span class="c1"></span>	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">echo_rwlock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="creating-the-misc-device">Creating the misc device</h4>
<p>Now that we have defined functions for handling read and write system calls, we will first create a <em>file_operations</em> structure,
setting the read and write members of the <em>file_operations</em> struct as the address of the functions we have defined.</p>
<p>Then we create the <em>miscdevice</em> structure, initializing some of its members:</p>
<ul>
<li>
<p><em>minor</em> is set to the minor number we want for our device.
If we use MISC_DYNAMIC_MINOR for this member, the kernel will assign any minor number that is available.
If we specify a number, the kernel will try to assign that minor number
but device registration may fail if that minor number is already used by some other device.</p>
</li>
<li>
<p><em>name</em> specifies the name of the device file</p>
</li>
<li>
<p><em>fops</em> member is set as the file_operations structure we created</p>
</li>
<li>
<p><em>mode</em> specifies the permissions for device file access.
It would be more readable to use macros than to write the octal permission value.
So we use permission macros defined in <a href="https://elixir.bootlin.com/linux/latest/source/include/linux/stat.h">include/linux/stat.h</a> and <a href="https://elixir.bootlin.com/linux/latest/source/include/uapi/linux/stat.h">include/uapi/linux/stat.h</a>.</p>
<p><em>S_IRUGO</em> denotes that User, Group and Others (UGO) have Read (R) permissions.
Similarly <em>S_IWUGO</em> denotes that User, Group and Others (UGO) have Write (W) permissions.
For the echo device, we want any user to have read and write access, so we use <em>(S_IRUGO|S_IWUGO)</em></p>
</li>
</ul>
<!--listend-->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">echo_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">echo_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">echo_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">echo_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">minor</span>	<span class="o">=</span> <span class="n">MISC_DYNAMIC_MINOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&#34;echo&#34;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">echo_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>	<span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUGO</span><span class="p">),</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="registering-the-misc-device">Registering the misc device</h4>
<p>In the module&rsquo;s initialization function, we first allocate space for the buffer.
Then we register the <em>miscdevice</em> struct that we initialized earlier using the <em>misc_register</em> function.
If the function returns 0, then the device has been created successfully.</p>
<p>In the exit function, we free the buffer and deregister the device using <em>misc_deregister</em> function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">echo_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">// Allocate a page sized buffer
</span><span class="c1"></span>	<span class="n">kernel_buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kernel_buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="c1">// Register misc char device
</span><span class="c1"></span>	<span class="k">if</span><span class="p">(</span><span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">echo_device</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">kfree</span><span class="p">(</span><span class="n">kernel_buffer</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">echo_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">// Free buffer
</span><span class="c1"></span>	<span class="n">kfree</span><span class="p">(</span><span class="n">kernel_buffer</span><span class="p">);</span>
	<span class="c1">// Unregister misc char device
</span><span class="c1"></span>	<span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">echo_device</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">echo_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">echo_exit</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="makefile">Makefile</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-make" data-lang="make"><span class="nv">obj-m</span> <span class="o">:=</span> echo.o
<span class="nf">all</span><span class="o">:</span>
	make -C /usr/lib/modules/<span class="k">$(</span>shell uname -r<span class="k">)</span>/build <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> modules
<span class="nf">clean</span><span class="o">:</span>
	make -C /usr/lib/modules/<span class="k">$(</span>shell uname -r<span class="k">)</span>/build <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> clean
</code></pre></td></tr></table>
</div>
</div><h3 id="testing-echo">Testing echo</h3>
<ul>
<li>
<p>Build and load the module</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">  make
  sudo insmod echo.ko
</code></pre></td></tr></table>
</div>
</div><p>The echo device will show up at /dev/echo</p>
</li>
<li>
<p>Write to the device</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">  <span class="nb">echo</span> <span class="s2">&#34;Good Morning!&#34;</span> &gt; /dev/echo
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Read from the device. It will return what was last written to it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">  cat /dev/echo
  <span class="c1"># Good Morning!</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Unload the module</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">  sudo rmmod <span class="nb">echo</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="references">References</h2>
<ul>
<li><a href="https://github.com/nifey/nifey.github.io/tree/master/code/misc%5Fchar%5Fdevices">Source code of echo module</a></li>
<li><a href="https://lwn.net/images/pdf/LDD3/ch03.pdf">LDD3 Chapter 3</a></li>
<li><a href="https://elixir.bootlin.com/linux/latest/source/include/linux/miscdevice.h">include/linux/miscdevice.h</a></li>
<li><a href="https://elixir.bootlin.com/linux/latest/source/include/linux/stat.h">include/linux/stat.h</a></li>
<li><a href="https://elixir.bootlin.com/linux/latest/source/include/uapi/linux/stat.h">include/uapi/linux/stat.h</a></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Abdun Nihaal</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        03-11-2021
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/linux/">linux</a>
          <a href="/tags/kernel/">kernel</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/updating_vulnerable_python_dependencies/">
            <span class="next-text nav-default">Updating vulnerable Python dependencies</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="https://www.twitter.com/nihaal_an" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://in.linkedin.com/in/abdun-nihaal-289272143" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="https://www.github.com/nifey" class="iconfont icon-github" title="github"></a>
      <a href="https://www.gitlab.com/nihaal" class="iconfont icon-gitlab" title="gitlab"></a>
  <a href="https://nihaal.me/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2016 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Abdun Nihaal</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>








</body>
</html>
